<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Notebook 2 ‚Äî Trip-level exploration and ‚Äúgoing home‚Äù behaviour ‚Äì Geolife Daily Mobility</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b4f4d60cfbc3b1e3dbcd7f2eeb7587ea.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./LR.html">Analysis</a></li><li class="breadcrumb-item"><a href="./by action.html">Notebook 2 ‚Äì Trips by action</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./LR.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Data Cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Notebook 1 ‚Äì Data cleaning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./by action.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Notebook 2 ‚Äì Trips by action</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./verification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Notebook 3 ‚Äì Cross-user verification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Findings and conclusion</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#from-daily-visits-to-homehome-trips" id="toc-from-daily-visits-to-homehome-trips" class="nav-link active" data-scroll-target="#from-daily-visits-to-homehome-trips">2. From daily visits to home‚Äìhome trips</a></li>
  <li><a href="#trip-level-descriptive-statistics" id="toc-trip-level-descriptive-statistics" class="nav-link" data-scroll-target="#trip-level-descriptive-statistics">3. Trip-level descriptive statistics</a></li>
  <li><a href="#next-step-behaviour-within-trips" id="toc-next-step-behaviour-within-trips" class="nav-link" data-scroll-target="#next-step-behaviour-within-trips">4. Next-step behaviour within trips</a>
  <ul class="collapse">
  <li><a href="#calculate-the-non-home-stops" id="toc-calculate-the-non-home-stops" class="nav-link" data-scroll-target="#calculate-the-non-home-stops">4.1 Calculate the non home stops</a></li>
  <li><a href="#discrete-time-hazard-of-going-home" id="toc-discrete-time-hazard-of-going-home" class="nav-link" data-scroll-target="#discrete-time-hazard-of-going-home">4.2 Discrete-time hazard of going home</a></li>
  <li><a href="#within-trip-exploration-when-do-new-places-pv-appear" id="toc-within-trip-exploration-when-do-new-places-pv-appear" class="nav-link" data-scroll-target="#within-trip-exploration-when-do-new-places-pv-appear">4.3 Within-Trip Exploration: When Do New Places (Pv) Appear?</a></li>
  <li><a href="#behavioural-summary" id="toc-behavioural-summary" class="nav-link" data-scroll-target="#behavioural-summary">4.3 Behavioural summary</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./LR.html">Analysis</a></li><li class="breadcrumb-item"><a href="./by action.html">Notebook 2 ‚Äì Trips by action</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Notebook 2 ‚Äî Trip-level exploration and ‚Äúgoing home‚Äù behaviour</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this notebook the analysis starts from the visit-level table constructed in Notebook 1. The file <code>visit_level_table_000.csv</code> is loaded from the <code>data</code> folder and the basic Python environment (NumPy, pandas, Matplotlib) is set up. Date and time fields are combined into full start and end timestamps for each visit (<code>first_dt</code> and <code>last_dt</code>), and the user identifier is taken from the <code>person</code> column for use in plots. The table is then sorted by person, date, and start time to produce a clean, time-ordered record of visit events rather than daily aggregates; subsequent sections build on this event sequence to identify complete home‚Äìhome trips (individual ‚Äúoutings‚Äù).</p>
<div id="625d83d0" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ignore"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    message<span class="op">=</span><span class="st">"DataFrameGroupBy.apply operated on the grouping columns"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    category<span class="op">=</span><span class="pp">FutureWarning</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5684db95" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Environment and data loading</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"default"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to the visit-level table saved from Notebook 1</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"data/visit_level_table_000.csv"</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>visit_table <span class="op">=</span> pd.read_csv(path)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows in visit_table:"</span>, <span class="bu">len</span>(visit_table))</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>display(visit_table.head())</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse date + times into full timestamps</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>visit_table[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(visit_table[<span class="st">"date"</span>]).dt.date</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>visit_table[<span class="st">"first_dt"</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    visit_table[<span class="st">"date"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> visit_table[<span class="st">"first_time"</span>]</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>visit_table[<span class="st">"last_dt"</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    visit_table[<span class="st">"date"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> visit_table[<span class="st">"last_time"</span>]</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the user ID from the table</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>USER_ID <span class="op">=</span> <span class="bu">str</span>(visit_table[<span class="st">"person"</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unique persons in this file:"</span>, visit_table[<span class="st">"person"</span>].unique())</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"USER_ID used in plots:"</span>, USER_ID)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure rows are ordered in time</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>visit_table <span class="op">=</span> (</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    visit_table</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"person"</span>, <span class="st">"date"</span>, <span class="st">"first_dt"</span>])</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows in visit_table after sorting:"</span>, <span class="bu">len</span>(visit_table))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows in visit_table: 1841</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">person</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">first_time</th>
<th data-quarto-table-cell-role="th">last_time</th>
<th data-quarto-table-cell-role="th">duration_min</th>
<th data-quarto-table-cell-role="th">grid_ci</th>
<th data-quarto-table-cell-role="th">grid_rj</th>
<th data-quarto-table-cell-role="th">grid_center_lon</th>
<th data-quarto-table-cell-role="th">grid_center_lat</th>
<th data-quarto-table-cell-role="th">dist_home_m</th>
<th data-quarto-table-cell-role="th">is_home</th>
<th data-quarto-table-cell-role="th">is_sw</th>
<th data-quarto-table-cell-role="th">is_pv</th>
<th data-quarto-table-cell-role="th">is_pn</th>
<th data-quarto-table-cell-role="th">place_id</th>
<th data-quarto-table-cell-role="th">next_step</th>
<th data-quarto-table-cell-role="th">visit_order_in_day</th>
<th data-quarto-table-cell-role="th">action_order</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>2008-10-23</td>
<td>03:00:55</td>
<td>04:13:32</td>
<td>72.6</td>
<td>40</td>
<td>50</td>
<td>116.300184</td>
<td>39.984308</td>
<td>3201.6</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>Pv1</td>
<td>sw</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0</td>
<td>2008-10-23</td>
<td>09:42:25</td>
<td>09:42:30</td>
<td>0.1</td>
<td>43</td>
<td>55</td>
<td>116.317527</td>
<td>40.006935</td>
<td>500.0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>SW</td>
<td>home</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>0</td>
<td>2008-10-23</td>
<td>09:42:35</td>
<td>10:05:29</td>
<td>22.9</td>
<td>44</td>
<td>55</td>
<td>116.323385</td>
<td>40.006970</td>
<td>0.0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>HOME</td>
<td>sw</td>
<td>3</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>0</td>
<td>2008-10-23</td>
<td>10:05:34</td>
<td>10:30:15</td>
<td>24.7</td>
<td>43</td>
<td>55</td>
<td>116.317527</td>
<td>40.006935</td>
<td>500.0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>SW</td>
<td>home</td>
<td>4</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>0</td>
<td>2008-10-23</td>
<td>10:30:20</td>
<td>11:10:57</td>
<td>40.6</td>
<td>44</td>
<td>55</td>
<td>116.323385</td>
<td>40.006970</td>
<td>0.0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>HOME</td>
<td>none</td>
<td>5</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unique persons in this file: [0]
USER_ID used in plots: 0
Rows in visit_table after sorting: 1841</code></pre>
</div>
</div>
<section id="from-daily-visits-to-homehome-trips" class="level2">
<h2 class="anchored" data-anchor-id="from-daily-visits-to-homehome-trips">2. From daily visits to home‚Äìhome trips</h2>
<p>The next stage groups individual visit events into complete home-to-home trips. For each person and each day, the visit records are ordered by their start times. Any record marked is_home == 1 is treated as being at HOME. A new trip begins the moment the user leaves HOME for a non-home location, continues through any consecutive non-home stops, and ends as soon as the user returns home. If the user never comes back home later that day, the trip is considered to end at the final non-home visit. This approach turns a simple list of places into meaningful ‚Äúoutings‚Äù that begin at home and eventually return there.</p>
<p>To make later analysis easier, each visit receives two indexing variables. The first, trip_id, indicates which trip of the day the visit belongs to, with 0 reserved for visits that do not fall inside any trip. The second, action_order_in_trip, captures the position of each stop within its trip. Non-home stops are numbered sequentially as 1, 2, 3, and so on, while HOME visits at the beginning or end of a trip are assigned 0. These indices create a clean structure for studying how behaviour unfolds over the course of each outing.</p>
<div id="f996c055" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_trip_cols(df_day):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    For a single (person, date), label home‚Äìhome trip episodes.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    - trip_id: which trip on that day (1, 2, ...), 0 if not in a trip.</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - action_order_in_trip: order within the current trip</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">      (1, 2, 3, ... for non-home visits, 0 for HOME).</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    df_day <span class="op">=</span> df_day.sort_values(<span class="st">"first_dt"</span>).copy()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    trip_id <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    action_order <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> <span class="va">False</span>  <span class="co"># currently away from HOME?</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    trip_ids <span class="op">=</span> []</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    action_orders <span class="op">=</span> []</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df_day.iterrows():</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">"is_home"</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Being at HOME: mark as outside any within-trip sequence</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> <span class="va">False</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            action_order <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            trip_ids.append(trip_id)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            action_orders.append(<span class="dv">0</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Non-home visit</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> out:</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Leaving home: start a new trip</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                trip_id <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                action_order <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>                out <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Continuing within the same trip</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>                action_order <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>            trip_ids.append(trip_id)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>            action_orders.append(action_order)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    df_day[<span class="st">"trip_id"</span>] <span class="op">=</span> trip_ids</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    df_day[<span class="st">"action_order_in_trip"</span>] <span class="op">=</span> action_orders</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_day</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>visit_table <span class="op">=</span> (</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    visit_table</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"person"</span>, <span class="st">"date"</span>], group_keys<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(add_trip_cols)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Trip-related columns (first 20 rows):"</span>)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    visit_table[</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"person"</span>, <span class="st">"date"</span>, <span class="st">"place_id"</span>, <span class="st">"is_home"</span>,</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>         <span class="st">"visit_order_in_day"</span>, <span class="st">"trip_id"</span>, <span class="st">"action_order_in_trip"</span>,</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>         <span class="st">"first_time"</span>, <span class="st">"last_time"</span>]</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    ].head(<span class="dv">10</span>)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of trips (trip_id &gt; 0):"</span>, (visit_table[<span class="st">"trip_id"</span>] <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">sum</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Trip-related columns (first 20 rows):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">person</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">place_id</th>
<th data-quarto-table-cell-role="th">is_home</th>
<th data-quarto-table-cell-role="th">visit_order_in_day</th>
<th data-quarto-table-cell-role="th">trip_id</th>
<th data-quarto-table-cell-role="th">action_order_in_trip</th>
<th data-quarto-table-cell-role="th">first_time</th>
<th data-quarto-table-cell-role="th">last_time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>2008-10-23</td>
<td>Pv1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>03:00:55</td>
<td>04:13:32</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0</td>
<td>2008-10-23</td>
<td>SW</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>2</td>
<td>09:42:25</td>
<td>09:42:30</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>0</td>
<td>2008-10-23</td>
<td>HOME</td>
<td>1</td>
<td>3</td>
<td>1</td>
<td>0</td>
<td>09:42:35</td>
<td>10:05:29</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>0</td>
<td>2008-10-23</td>
<td>SW</td>
<td>0</td>
<td>4</td>
<td>2</td>
<td>1</td>
<td>10:05:34</td>
<td>10:30:15</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>0</td>
<td>2008-10-23</td>
<td>HOME</td>
<td>1</td>
<td>5</td>
<td>2</td>
<td>0</td>
<td>10:30:20</td>
<td>11:10:57</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>0</td>
<td>2008-10-24</td>
<td>SW</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>02:09:59</td>
<td>02:10:54</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>0</td>
<td>2008-10-24</td>
<td>HOME</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>0</td>
<td>02:10:59</td>
<td>02:47:06</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>0</td>
<td>2008-10-26</td>
<td>Pv4</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>14:04:27</td>
<td>14:12:42</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>0</td>
<td>2008-10-26</td>
<td>Pv5</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>2</td>
<td>14:23:42</td>
<td>14:35:17</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>0</td>
<td>2008-10-27</td>
<td>HOME</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>12:03:59</td>
<td>12:05:54</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of trips (trip_id &gt; 0): 1805</code></pre>
</div>
</div>
</section>
<section id="trip-level-descriptive-statistics" class="level2">
<h2 class="anchored" data-anchor-id="trip-level-descriptive-statistics">3. Trip-level descriptive statistics</h2>
<p>The visit-level data are next collapsed to the trip level. For each combination of person, date, and trip_id, a single row is created that records the number of non-home stops (n_stops), the start and end times of the trip (trip_start, trip_end), and the maximum and average distance from HOME reached during that outing (max_dist_home, mean_dist_home). Simple summaries and histograms based on this trip-level table, especially for n_stops and max_dist_home, show how long typical outings last and how far the user usually travels away from home.</p>
<div id="b98bfe09" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only visits that belong to a trip</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>vt_trip <span class="op">=</span> visit_table[visit_table[<span class="st">"trip_id"</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>trip_summary <span class="op">=</span> (</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    vt_trip</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"person"</span>, <span class="st">"date"</span>, <span class="st">"trip_id"</span>], as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        n_stops<span class="op">=</span>(<span class="st">"action_order_in_trip"</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">sum</span>()),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        trip_start<span class="op">=</span>(<span class="st">"first_dt"</span>, <span class="st">"min"</span>),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        trip_end<span class="op">=</span>(<span class="st">"last_dt"</span>, <span class="st">"max"</span>),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        max_dist_home<span class="op">=</span>(<span class="st">"dist_home_m"</span>, <span class="st">"max"</span>),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        mean_dist_home<span class="op">=</span>(<span class="st">"dist_home_m"</span>, <span class="st">"mean"</span>),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>trip_summary[<span class="st">"trip_duration_min"</span>] <span class="op">=</span> (</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    (trip_summary[<span class="st">"trip_end"</span>] <span class="op">-</span> trip_summary[<span class="st">"trip_start"</span>])</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    .dt.total_seconds() <span class="op">/</span> <span class="fl">60.0</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of trips:"</span>, <span class="bu">len</span>(trip_summary))</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>display(trip_summary.head())</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3.1 Histogram of stops per trip ---</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>plt.hist(trip_summary[<span class="st">"n_stops"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Number of non-home stops in trip"</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of trips"</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Stops per trip ‚Äî user </span><span class="sc">{</span>USER_ID<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3.2 Histogram of max distance from HOME per trip ---</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>plt.hist(trip_summary[<span class="st">"max_dist_home"</span>], bins<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Maximum distance from HOME (m)"</span>)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of trips"</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Maximum distance from HOME per trip ‚Äî user </span><span class="sc">{</span>USER_ID<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of trips: 429</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">person</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">trip_id</th>
<th data-quarto-table-cell-role="th">n_stops</th>
<th data-quarto-table-cell-role="th">trip_start</th>
<th data-quarto-table-cell-role="th">trip_end</th>
<th data-quarto-table-cell-role="th">max_dist_home</th>
<th data-quarto-table-cell-role="th">mean_dist_home</th>
<th data-quarto-table-cell-role="th">trip_duration_min</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>2008-10-23</td>
<td>1</td>
<td>2</td>
<td>2008-10-23 03:00:55</td>
<td>2008-10-23 10:05:29</td>
<td>3201.6</td>
<td>1233.866667</td>
<td>424.566667</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0</td>
<td>2008-10-23</td>
<td>2</td>
<td>1</td>
<td>2008-10-23 10:05:34</td>
<td>2008-10-23 11:10:57</td>
<td>500.0</td>
<td>250.000000</td>
<td>65.383333</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>0</td>
<td>2008-10-24</td>
<td>1</td>
<td>1</td>
<td>2008-10-24 02:09:59</td>
<td>2008-10-24 02:47:06</td>
<td>500.0</td>
<td>250.000000</td>
<td>37.116667</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>0</td>
<td>2008-10-26</td>
<td>1</td>
<td>2</td>
<td>2008-10-26 14:04:27</td>
<td>2008-10-26 14:35:17</td>
<td>13416.4</td>
<td>12857.400000</td>
<td>30.833333</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>0</td>
<td>2008-10-28</td>
<td>1</td>
<td>20</td>
<td>2008-10-28 00:38:26</td>
<td>2008-10-28 02:52:11</td>
<td>2549.5</td>
<td>2214.280952</td>
<td>133.750000</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="by action_files/figure-html/cell-5-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="by action_files/figure-html/cell-5-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>For user 000 there are 429 identified home‚Äìhome trips. The histogram of n_stops shows that most trips are very simple: the median is one non-home stop and the vast majority of outings contain only one or two stops, with a long but thin right tail of unusually complex trips (up to nearly 100 recorded stops). The distribution of max_dist_home tells a similar story on the spatial side. Most trips remain within a few kilometres of HOME, but there are occasional long-distance excursions that reach tens of kilometres away. Together, these summaries highlight a pattern of frequent short errands around home punctuated by rare, much longer journeys.</p>
</section>
<section id="next-step-behaviour-within-trips" class="level2">
<h2 class="anchored" data-anchor-id="next-step-behaviour-within-trips">4. Next-step behaviour within trips</h2>
<section id="calculate-the-non-home-stops" class="level3">
<h3 class="anchored" data-anchor-id="calculate-the-non-home-stops">4.1 Calculate the non home stops</h3>
<p>The analysis now shifts from entire home‚Äìhome trips to the individual non-home stops that occur within each trip. At each such stop, the key question becomes: what happens next? Rather than focusing on the whole sequence, we examine the immediate next step following each non-home visit.</p>
<p>Within each trip episode, three possible next-step outcomes are defined. The first is home, meaning that the next recorded stop is a return to HOME. The second is explore, in which the individual continues the trip by visiting another non-home location‚Äîthis may be a SW, Pv, or Pn place. The third is end, indicating that the trip terminates in the data and no further stop is observed.</p>
<p>A special rule is applied to the last non-home stop of each trip. When this final stop is labeled end, it often reflects the end of the day rather than a genuine termination of activity away from home. To avoid treating these end-of-day records as if the person remained out indefinitely, we reclassify an end outcome as effectively going home if the stop occurs late at night (hour ‚â• 23) or is very close to HOME (within 750 m). This adjustment ensures that outcome categories are more comparable across different stops and reduces artificial inflation of ‚Äúend‚Äù events.</p>
<p>After this reclassification, the resulting next-step outcomes are tabulated by the stop order ùëò k within each trip. This tabulation describes how the relative frequencies of ‚Äúgo home,‚Äù ‚Äúkeep exploring,‚Äù and ‚Äúend‚Äù evolve as a trip progresses, providing a clearer picture of within-trip behavioral dynamics.</p>
<div id="c7f85136" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>MAXK <span class="op">=</span> <span class="dv">30</span>        <span class="co"># only consider the first 30 stops within each trip</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>NIGHT_HOUR <span class="op">=</span> <span class="dv">23</span>  <span class="co"># &gt;= 23:00 considered "late"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>NEAR_HOME_M <span class="op">=</span> <span class="dv">750</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-home visits that are part of a trip and have a positive action order</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>vis <span class="op">=</span> visit_table[</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    (visit_table[<span class="st">"is_home"</span>] <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    (visit_table[<span class="st">"trip_id"</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    (visit_table[<span class="st">"action_order_in_trip"</span>] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>vis <span class="op">=</span> vis[vis[<span class="st">"action_order_in_trip"</span>] <span class="op">&lt;=</span> MAXK].copy()</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Non-home visit events inside trips:"</span>, <span class="bu">len</span>(vis))</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Raw next_step value counts (non-home):"</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(vis[<span class="st">"next_step"</span>].value_counts())</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Classify next-step outcomes ---</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>vis[<span class="st">"outcome"</span>] <span class="op">=</span> np.where(</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    vis[<span class="st">"next_step"</span>] <span class="op">==</span> <span class="st">"home"</span>, <span class="st">"home"</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    np.where(vis[<span class="st">"next_step"</span>].isin([<span class="st">"sw"</span>, <span class="st">"pv"</span>, <span class="st">"pn"</span>]), <span class="st">"explore"</span>, <span class="st">"end"</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the last non-home visit of each trip</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>last_mask <span class="op">=</span> vis.groupby(</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"person"</span>, <span class="st">"date"</span>, <span class="st">"trip_id"</span>]</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>).cumcount(ascending<span class="op">=</span><span class="va">False</span>).eq(<span class="dv">0</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Late or near home?</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>last_time_dt <span class="op">=</span> pd.to_datetime(vis[<span class="st">"last_time"</span>], <span class="bu">format</span><span class="op">=</span><span class="st">"%H:%M:%S"</span>, errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>late <span class="op">=</span> last_time_dt.dt.hour.ge(NIGHT_HOUR)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>near <span class="op">=</span> vis[<span class="st">"dist_home_m"</span>].le(NEAR_HOME_M)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Reclassify terminal 'end' as 'home' if late or near HOME</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>vis.loc[</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    last_mask <span class="op">&amp;</span> (vis[<span class="st">"outcome"</span>] <span class="op">==</span> <span class="st">"end"</span>) <span class="op">&amp;</span> (late <span class="op">|</span> near),</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"outcome"</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>] <span class="op">=</span> <span class="st">"home"</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Outcome counts after reclassification:"</span>)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(vis[<span class="st">"outcome"</span>].value_counts())</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome proportions by stop order k in trip ---</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> (</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    vis.groupby(<span class="st">"action_order_in_trip"</span>)[<span class="st">"outcome"</span>]</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>       .value_counts()</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>       .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>       .reindex(<span class="bu">range</span>(<span class="dv">1</span>, MAXK <span class="op">+</span> <span class="dv">1</span>), fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>counts[<span class="st">"total"</span>] <span class="op">=</span> counts.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>props <span class="op">=</span> counts.div(</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    counts[<span class="st">"total"</span>].where(counts[<span class="st">"total"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, np.nan),</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Outcome composition (first 10 k):"</span>)</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>display(props[[<span class="st">"explore"</span>, <span class="st">"home"</span>, <span class="st">"end"</span>]].head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-home visit events inside trips: 1306

Raw next_step value counts (non-home):
next_step
pn      632
home    338
pv      219
none     85
sw       32
Name: count, dtype: int64

Outcome counts after reclassification:
outcome
explore    883
home       403
end         20
Name: count, dtype: int64

Outcome composition (first 10 k):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">outcome</th>
<th data-quarto-table-cell-role="th">explore</th>
<th data-quarto-table-cell-role="th">home</th>
<th data-quarto-table-cell-role="th">end</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">action_order_in_trip</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>0.333333</td>
<td>0.657343</td>
<td>0.009324</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2</th>
<td>0.874126</td>
<td>0.090909</td>
<td>0.034965</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>0.648000</td>
<td>0.328000</td>
<td>0.024000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>0.901235</td>
<td>0.086420</td>
<td>0.012346</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5</th>
<td>0.684932</td>
<td>0.301370</td>
<td>0.013699</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">6</th>
<td>0.880000</td>
<td>0.100000</td>
<td>0.020000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">7</th>
<td>0.840909</td>
<td>0.113636</td>
<td>0.045455</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">8</th>
<td>0.918919</td>
<td>0.081081</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>0.911765</td>
<td>0.088235</td>
<td>0.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">10</th>
<td>0.935484</td>
<td>0.064516</td>
<td>0.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For user <code>000</code> there are 1,306 non-home stops inside trips, of which 883 are followed by another non-home place (explore), 403 by a return home, and only 20 end the trip without a further visit after the late/near-home reclassification. The composition by stop order (k) shows a clear pattern: at the <strong>first</strong> stop, going home is very common (around two thirds of trips return home immediately and only one third continue to explore). Once a trip survives this first stop, however, exploration dominates: for (k = 2) and beyond, 65‚Äì90% of stops are followed by another non-home place and the hazard of going home falls to around 10‚Äì30%. In other words, many trips are short one-stop errands, but conditional on not going straight home, the user tends to string together several exploratory stops before ending the outing.</p>
</section>
<section id="discrete-time-hazard-of-going-home" class="level3">
<h3 class="anchored" data-anchor-id="discrete-time-hazard-of-going-home">4.2 Discrete-time hazard of going home</h3>
<p>Within each trip, non-home stops are treated as discrete time steps: the first stop after leaving HOME, the second stop, the third stop, and so on. At each step, the analysis focuses on what happens next conditional on the trip having reached that point. For every step number (k), the data across all trips are pooled to compute two quantities: the total number of trips that have reached at least the (k)-th non-home stop, and, among those, the number of trips that return directly to HOME immediately after stop (k).</p>
<p>The ratio of these two counts defines the hazard of going home at step (k),</p>
<p><code>h_k = P(go home next | trip has reached stop k)</code>,</p>
<p>which answers: <em>given that this trip has already made it to stop (k), what is the probability that the next move is to go home rather than continue exploring?</em> This discrete-time hazard summarizes how the immediate ‚Äúgo home now‚Äù tendency changes as the trip accumulates more non-home stops.</p>
<p>Based on the hazards, the analysis also derives the <strong>survival probability</strong> (S_k), defined as the probability that a trip is still ongoing after (k) non-home stops. In discrete time, this is obtained by multiplying (1 - h_k)&nbsp;across successive steps, as the chance that the individual has not yet decided to return home. Intuitively, (S_k) represents the probability that the person is ‚Äústill out‚Äù after making (k) stops away from home.</p>
<p>The first panel visualizes the empirical hazards (h_k) together with a simple logit trend in (k) fitted for (k ), showing how the propensity to go home varies with stop order. The second panel compares the empirical survival curve (S_k) with the corresponding model-based survival curve implied by the fitted hazard specification. Together, these plots illustrate how both the ‚Äúgo home now‚Äù probability and the ‚Äústill out‚Äù probability evolve as trips become longer.</p>
<div id="ba43393d" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Per-trip maximum stop order (within the MAXK truncation)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>pertrip_maxk <span class="op">=</span> (</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    vis.groupby([<span class="st">"person"</span>, <span class="st">"date"</span>, <span class="st">"trip_id"</span>])[<span class="st">"action_order_in_trip"</span>]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>       .<span class="bu">max</span>()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Risk set: number of trips that reach at least stop k</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>at_risk <span class="op">=</span> pd.Series(</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    {k: <span class="bu">int</span>((pertrip_maxk <span class="op">&gt;=</span> k).<span class="bu">sum</span>()) <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, MAXK <span class="op">+</span> <span class="dv">1</span>)},</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"at_risk"</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of trips where the k-th stop is followed by "home"</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>home_k <span class="op">=</span> (</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    vis[vis[<span class="st">"outcome"</span>] <span class="op">==</span> <span class="st">"home"</span>]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"action_order_in_trip"</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    .reindex(<span class="bu">range</span>(<span class="dv">1</span>, MAXK <span class="op">+</span> <span class="dv">1</span>), fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"home_k"</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>hazard <span class="op">=</span> (home_k <span class="op">/</span> at_risk.replace(<span class="dv">0</span>, np.nan)).rename(<span class="st">"hazard"</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>haz_df <span class="op">=</span> pd.concat([home_k, at_risk, hazard], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Hazard table (first 10 k):"</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>display(haz_df.head(<span class="dv">10</span>))</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Empirical survival S_k ----------</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>k_axis <span class="op">=</span> np.arange(<span class="dv">1</span>, MAXK <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>haz_vals_emp <span class="op">=</span> hazard.reindex(k_axis).fillna(<span class="dv">0</span>).values</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>S_emp <span class="op">=</span> []</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> hk <span class="kw">in</span> haz_vals_emp:</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    s <span class="op">*=</span> (<span class="dv">1</span> <span class="op">-</span> hk)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    S_emp.append(s)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>S_emp <span class="op">=</span> np.array(S_emp)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Simple logit trend for hazard (k&gt;=2) ----------</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>MIN_RISK <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>haz_fit <span class="op">=</span> (</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    haz_df</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    .loc[haz_df.index <span class="op">&gt;=</span> <span class="dv">2</span>] </span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    .loc[<span class="kw">lambda</span> df: df[<span class="st">"at_risk"</span>] <span class="op">&gt;=</span> MIN_RISK]</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Ks used in hazard fit:"</span>, haz_fit.index.tolist())</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>k_fit <span class="op">=</span> haz_fit.index.values.astype(<span class="bu">float</span>)</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(k_fit)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.column_stack([</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    haz_fit[<span class="st">"home_k"</span>].values,</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    (haz_fit[<span class="st">"at_risk"</span>] <span class="op">-</span> haz_fit[<span class="st">"home_k"</span>]).values</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>glm <span class="op">=</span> sm.GLM(y, X, family<span class="op">=</span>sm.families.Binomial())</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>res_haz <span class="op">=</span> glm.fit()</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(res_haz.summary2().tables[<span class="dv">1</span>])</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> res_haz.params[<span class="dv">0</span>]</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>beta  <span class="op">=</span> res_haz.params[<span class="dv">1</span>]</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>X_pred <span class="op">=</span> sm.add_constant(k_axis[<span class="dv">1</span>:])</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>haz_hat_tail <span class="op">=</span> res_haz.predict(X_pred)</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>h1_emp <span class="op">=</span> haz_df.loc[<span class="dv">1</span>, <span class="st">"hazard"</span>]</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>haz_hat <span class="op">=</span> np.concatenate([[h1_emp], haz_hat_tail])</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>S_hat <span class="op">=</span> []</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> hk <span class="kw">in</span> haz_hat:</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>    s <span class="op">*=</span> (<span class="dv">1</span> <span class="op">-</span> hk)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>    S_hat.append(s)</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>S_hat <span class="op">=</span> np.array(S_hat)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Plot hazard: empirical vs fitted ----------</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>plt.plot(k_axis, haz_vals_emp, marker<span class="op">=</span><span class="st">"o"</span>, label<span class="op">=</span><span class="st">"Empirical hazard"</span>)</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>plt.plot(k_axis, haz_hat, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"Logit trend (k‚â•2)"</span>)</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Stop order k in trip"</span>)</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"P(go home | trip has reached k)"</span>)</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Hazard of going home after k-th stop in a trip ‚Äî user </span><span class="sc">{</span>USER_ID<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Plot survival: empirical vs fitted ----------</span></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>plt.plot(k_axis, S_emp, marker<span class="op">=</span><span class="st">"o"</span>, label<span class="op">=</span><span class="st">"Empirical S_k"</span>)</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>plt.plot(k_axis, S_hat, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"Model-based S_k"</span>)</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Stop order k in trip"</span>)</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"P(still out after k)"</span>)</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Survival of staying out within a trip ‚Äî user </span><span class="sc">{</span>USER_ID<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hazard table (first 10 k):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">home_k</th>
<th data-quarto-table-cell-role="th">at_risk</th>
<th data-quarto-table-cell-role="th">hazard</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>282</td>
<td>429</td>
<td>0.657343</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2</th>
<td>13</td>
<td>143</td>
<td>0.090909</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>41</td>
<td>125</td>
<td>0.328000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>7</td>
<td>81</td>
<td>0.086420</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5</th>
<td>22</td>
<td>73</td>
<td>0.301370</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">6</th>
<td>5</td>
<td>50</td>
<td>0.100000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">7</th>
<td>5</td>
<td>44</td>
<td>0.113636</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">8</th>
<td>3</td>
<td>37</td>
<td>0.081081</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>3</td>
<td>34</td>
<td>0.088235</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">10</th>
<td>2</td>
<td>31</td>
<td>0.064516</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Ks used in hazard fit: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
          Coef.  Std.Err.         z         P&gt;|z|    [0.025   0.975]
const -1.217758  0.194916 -6.247605  4.167954e-10 -1.599786 -0.83573
x1    -0.092337  0.033081 -2.791279  5.250023e-03 -0.157174 -0.02750</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="by action_files/figure-html/cell-7-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="by action_files/figure-html/cell-7-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="within-trip-exploration-when-do-new-places-pv-appear" class="level3">
<h3 class="anchored" data-anchor-id="within-trip-exploration-when-do-new-places-pv-appear">4.3 Within-Trip Exploration: When Do New Places (Pv) Appear?</h3>
<p>The analysis now moves from going-home decisions to <strong>exploration within a trip</strong>. For every non-home stop, we know whether the location is a first-time place for the user (Pv) or a return to an already visited place (Pn).</p>
<p>To study how exploration changes as a trip unfolds, the stops are ordered by their position within the trip. For each stop number (k), the share of stops that are Pv is calculated. This produces an empirical curve showing how often new places appear at different stages of a trip.</p>
<p>For user <code>000</code>, about 18% of all non-home stops across trips are first-time places. The exploration rate is relatively low in the first few stops but gradually increases as the trip continues, reaching roughly 30% around the 8th to 10th stop. A simple logit regression, applied only to stop numbers with enough observations, provides the smooth trend line shown in the figure. The estimated effect suggests that each additional stop in a trip increases the odds of discovering a new place by around one quarter.</p>
<div id="cafbcfc2" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-home visits inside trips (same base as for hazard)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>vis_places <span class="op">=</span> visit_table[</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    (visit_table[<span class="st">"is_home"</span>] <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    (visit_table[<span class="st">"trip_id"</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    (visit_table[<span class="st">"action_order_in_trip"</span>] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>vis_places <span class="op">=</span> vis_places[vis_places[<span class="st">"action_order_in_trip"</span>] <span class="op">&lt;=</span> MAXK].copy()</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Counts by stop order: how often is the stop Pv vs Pn?</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>pv_by_k <span class="op">=</span> (</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    vis_places</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"action_order_in_trip"</span>)[[<span class="st">"is_pv"</span>, <span class="st">"is_pn"</span>]]</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        pv_cnt<span class="op">=</span>(<span class="st">"is_pv"</span>, <span class="st">"sum"</span>),</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        pn_cnt<span class="op">=</span>(<span class="st">"is_pn"</span>, <span class="st">"sum"</span>),</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        n<span class="op">=</span>(<span class="st">"is_pv"</span>, <span class="st">"size"</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>pv_by_k[<span class="st">"pv_rate"</span>] <span class="op">=</span> pv_by_k[<span class="st">"pv_cnt"</span>] <span class="op">/</span> (</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    pv_by_k[<span class="st">"pv_cnt"</span>] <span class="op">+</span> pv_by_k[<span class="st">"pn_cnt"</span>]</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>).replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>overall_pv <span class="op">=</span> vis_places[<span class="st">"is_pv"</span>].mean()</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Overall share of first-time places (Pv) among non-home trip stops:"</span>,</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>      <span class="bu">round</span>(overall_pv, <span class="dv">3</span>))</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Pv rate by stop order k (first 10 k):"</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>display(pv_by_k[[<span class="st">"action_order_in_trip"</span>, <span class="st">"pv_rate"</span>]].head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overall share of first-time places (Pv) among non-home trip stops: 0.181

Pv rate by stop order k (first 10 k):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">action_order_in_trip</th>
<th data-quarto-table-cell-role="th">pv_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>0.097561</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2</td>
<td>0.153285</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>3</td>
<td>0.126126</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>4</td>
<td>0.164557</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>5</td>
<td>0.144928</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>6</td>
<td>0.265306</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>7</td>
<td>0.279070</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>8</td>
<td>0.297297</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>9</td>
<td>0.272727</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>10</td>
<td>0.322581</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="8e793d80" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pv_by_k <span class="op">=</span> pv_by_k.copy() </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>MIN_N <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>valid_k <span class="op">=</span> pv_by_k.loc[pv_by_k[<span class="st">"n"</span>] <span class="op">&gt;=</span> MIN_N, <span class="st">"action_order_in_trip"</span>]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Ks with n &gt;= 30:"</span>, valid_k.tolist())</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>vis_lr_sub <span class="op">=</span> vis_places[</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    vis_places[<span class="st">"action_order_in_trip"</span>].isin(valid_k)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>vis_lr_sub[<span class="st">"k_centered"</span>] <span class="op">=</span> (</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    vis_lr_sub[<span class="st">"action_order_in_trip"</span>]</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> vis_lr_sub[<span class="st">"action_order_in_trip"</span>].mean()</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(vis_lr_sub[<span class="st">"k_centered"</span>])</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> vis_lr_sub[<span class="st">"is_pv"</span>]</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>logit_model <span class="op">=</span> sm.Logit(y, X)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> logit_model.fit(disp<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(res.summary2().tables[<span class="dv">1</span>])</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>beta0 <span class="op">=</span> res.params[<span class="st">"const"</span>]</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>beta1 <span class="op">=</span> res.params[<span class="st">"k_centered"</span>]</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>odds_ratio <span class="op">=</span> np.exp(beta1)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Odds ratio for Pv per additional stop (n&gt;=</span><span class="sc">{</span>MIN_N<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>odds_ratio<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>k_max <span class="op">=</span> <span class="bu">int</span>(valid_k.<span class="bu">max</span>())</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>k_grid <span class="op">=</span> np.arange(<span class="dv">1</span>, k_max <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>k_grid_c <span class="op">=</span> k_grid <span class="op">-</span> vis_lr_sub[<span class="st">"action_order_in_trip"</span>].mean()</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>lin_pred <span class="op">=</span> beta0 <span class="op">+</span> beta1 <span class="op">*</span> k_grid_c</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>p_hat <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(<span class="op">-</span>lin_pred))</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>pv_plot <span class="op">=</span> pv_by_k[pv_by_k[<span class="st">"action_order_in_trip"</span>] <span class="op">&lt;=</span> k_max]</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">4</span>))</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>plt.plot(</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    pv_plot[<span class="st">"action_order_in_trip"</span>],</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    pv_plot[<span class="st">"pv_rate"</span>],</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="st">"o"</span>,</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Empirical Pv share"</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>plt.plot(</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    k_grid,</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    p_hat,</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    linestyle<span class="op">=</span><span class="st">"--"</span>,</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="ss">f"Logit trend (n‚â•</span><span class="sc">{</span>MIN_N<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>plt.axhline(</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    overall_pv,</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"gray"</span>,</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    linestyle<span class="op">=</span><span class="st">"--"</span>,</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Overall Pv share"</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">1</span>, k_max)</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Stop order k in trip (non-home)"</span>)</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"P(stop is Pv | stop at k)"</span>)</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Within-trip Pv probability ‚Äî user </span><span class="sc">{</span>USER_ID<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ks with n &gt;= 30: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
               Coef.  Std.Err.          z         P&gt;|z|    [0.025    0.975]
const      -2.074610  0.103630 -20.019307  3.738832e-89 -2.277722 -1.871498
k_centered  0.236422  0.031935   7.403330  1.328116e-13  0.173831  0.299013
Odds ratio for Pv per additional stop (n&gt;=30): 1.267</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="by action_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="behavioural-summary" class="level3">
<h3 class="anchored" data-anchor-id="behavioural-summary">4.3 Behavioural summary</h3>
<ul>
<li><p>Everyday mobility is dominated by short, nearby home‚Äìhome trips. Most outings contain only a few non-home stops, and the typical activity radius is tightly clustered around HOME; long-distance excursions show up as rare outliers.</p></li>
<li><p>Within a single trip, there is a large mass of ‚Äúone-stop errands‚Äù that return straight home, producing a very high probability of going home after the first stop. Conditional on surviving this initial stage, the per-stop hazard of returning home declines with stop order: once a trip has been running for a while, the person becomes increasingly ‚Äústicky‚Äù to staying out.</p></li>
<li><p>Along the same trip, early stops are mostly revisits to familiar locations, whereas the share of first-time places (Pv) rises steadily with stop order. Exploration is therefore concentrated in the middle and later parts of a trip, once the outing has ‚Äúwarmed up‚Äù.</p></li>
</ul>
<p>Taken together, these patterns can be summarised as follows: most days involve short errands close to home; when a longer outing does occur, the person tends to stay out for a while and becomes progressively more likely to explore new places.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Geolife Daily Mobility</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with Quarto</p>
</div>
  </div>
</footer>




</body></html>